<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"> 
    <title>–ü–æ–∏—Å–∫ –ø–µ—Å–µ–Ω</title>
    <link rel="stylesheet" href="/static/styles.css">

</head>
<body>
    {% include 'header.html' %}

    {% if request.query_params.get("status") == "success" %}
        <div class="message success">‚úÖ –ü–µ—Å–Ω—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!</div>
    {% elif request.query_params.get("status") == "error" %}
        <div class="message error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Å–Ω–∏.</div>
    {% endif %}

    <form action="/songs" method="get">
        <input type="text" name="q" value="{{ query }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏">
        <button type="submit">üîç –ù–∞–π—Ç–∏</button>
    </form>

    {% if songs %}
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h2>
        <ul id="song-list">
            {% for song in songs %}
                <li 
                    data-preview="{{ song.preview }}" 
                    data-title="{{ song.title }}" 
                    data-artist="{{ song.artist.name }}" 
                    tabindex="0"
                    role="button"
                    aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ {{ song.title }} - {{ song.artist.name }}"
                >
                    <img src="{{ song.album.cover_small }}" alt="–û–±–ª–æ–∂–∫–∞ {{ song.title }}">
                    <div class="song-info">
                        <strong>{{ song.title }}</strong><br>
                        {{ song.artist.name }}<br>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –°–∫–∞—á–∞—Ç—å -->
                    <form onsubmit="return downloadSong(event, this);" action="/download" method="post" aria-label="–°–∫–∞—á–∞—Ç—å {{ song.title }}">
                        <input type="hidden" name="title" value="{{ song.title }}">
                        <input type="hidden" name="artist" value="{{ song.artist.name }}">
                        <input type="hidden" name="query" value="{{ query }}">
                        <input type="hidden" name="referer" value="search">
                        <input type="hidden" name="genre" value="{{ song.genre or 'Unknown' }}">
                        <button type="submit">‚¨á –°–∫–∞—á–∞—Ç—å</button>
                    </form>  

                    <!-- –ö–Ω–æ–ø–∫–∞ –õ–∞–π–∫ -->
                    <form onsubmit="likeSong(event, this)" method="post" aria-label="–õ–∞–π–∫–Ω—É—Ç—å {{ song.title }}">
                        <input type="hidden" name="title" value="{{ song.title }}">
                        <input type="hidden" name="artist" value="{{ song.artist.name }}">
                        <input type="hidden" name="genre" value="{{ song.genre or 'Unknown' }}">
                        <button type="submit">‚ù§Ô∏è –õ–∞–π–∫</button>
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è -->
    <audio id="audio-player" preload="none" style="display:none;"></audio>

    <div class="player-bar" aria-live="polite" aria-atomic="true" role="region" aria-label="–ü–ª–µ–µ—Ä">
        <div class="player-info" id="current-song-info">–ü–µ—Å–Ω—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
        <input type="range" id="seek-slider" min="0" max="100" value="0" step="1" aria-label="–ü–æ–ª–∑—É–Ω–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è">

        <div class="player-controls">
            <button id="prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –ø–µ—Å–Ω—è">‚èÆÔ∏è</button>
            <button id="play-pause" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–ø–∞—É–∑–∞">‚ñ∂Ô∏è</button>
            <button id="next" aria-label="–°–ª–µ–¥—É—é—â–∞—è –ø–µ—Å–Ω—è">‚è≠Ô∏è</button>
            <button id="shuffle" aria-label="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å">üîÄ</button>
        </div>
    </div>
    <div id="time-display" aria-live="off"></div>

<script>
    // –°–µ–ª–µ–∫—Ç–æ—Ä—ã
    const audioPlayer = document.getElementById('audio-player');
    const songList = document.getElementById('song-list');
    const playPauseBtn = document.getElementById('play-pause');
    const shuffleBtn = document.getElementById('shuffle');
    const playerInfo = document.getElementById('current-song-info');
    const seekSlider = document.getElementById('seek-slider');
    const timeDisplay = document.getElementById('time-display');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');

    let songs = [];
    if (songList) {
        songs = Array.from(songList.querySelectorAll('li'));
    }
    let currentIndex = -1;
    let isPlaying = false;
    let isShuffle = false;
    let shuffledOrder = [];
    let shuffledIndex = -1;

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    function shuffleArray(array) {
        let shuffled = array.slice();
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function setActiveSong(index) {
        songs.forEach((el, i) => el.classList.toggle('playing', i === index));
    }

    function playSong(index) {
        if (index < 0 || index >= songs.length) return;
        currentIndex = index;
        const songItem = songs[index];
        const previewUrl = songItem.getAttribute('data-preview');
        const title = songItem.getAttribute('data-title') || 'Unknown';
        const artist = songItem.getAttribute('data-artist') || '';
        playerInfo.textContent = `${title} ‚Äî ${artist}`;
        audioPlayer.src = previewUrl;
        audioPlayer.play().then(() => {
            isPlaying = true;
            playPauseBtn.textContent = "‚è∏Ô∏è";
            setActiveSong(index);
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', err);
            playerInfo.textContent = "–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è";
        });
    }

    function getNextIndex() {
        if (isShuffle) {
            if (shuffledIndex + 1 < shuffledOrder.length) {
                return shuffledOrder[++shuffledIndex];
            } else {
                shuffledOrder = shuffleArray([...Array(songs.length).keys()]);
                shuffledIndex = 0;
                return shuffledOrder[shuffledIndex];
            }
        } else {
            return (currentIndex + 1) % songs.length;
        }
    }

    function playNext() {
        playSong(getNextIndex());
    }

    function getPrevIndex() {
        if (isShuffle) {
            if (shuffledIndex - 1 >= 0) {
                return shuffledOrder[--shuffledIndex];
            } else {
                shuffledOrder = shuffleArray([...Array(songs.length).keys()]);
                shuffledIndex = shuffledOrder.length - 1;
                return shuffledOrder[shuffledIndex];
            }
        } else {
            return (currentIndex - 1 + songs.length) % songs.length;
        }
    }

    function playPrev() {
        playSong(getPrevIndex());
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    playPauseBtn.addEventListener('click', () => {
        if (!audioPlayer.src) {
            if (songs.length > 0) {
                playSong(0);
            }
            return;
        }
        if (isPlaying) {
            audioPlayer.pause();
            isPlaying = false;
            playPauseBtn.textContent = "‚ñ∂Ô∏è";
        } else {
            audioPlayer.play();
            isPlaying = true;
            playPauseBtn.textContent = "‚è∏Ô∏è";
        }
    });

    shuffleBtn.addEventListener('click', () => {
        isShuffle = !isShuffle;
        shuffleBtn.style.color = isShuffle ? 'green' : '';
        if (isShuffle) {
            shuffledOrder = shuffleArray([...Array(songs.length).keys()]);
            shuffledIndex = shuffledOrder.indexOf(currentIndex);
        }
    });

    prevBtn.addEventListener('click', () => {
        playPrev();
    });

    nextBtn.addEventListener('click', () => {
        playNext();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    audioPlayer.addEventListener('timeupdate', () => {
        if (audioPlayer.duration) {
            const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            seekSlider.value = progressPercent;
            timeDisplay.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;
        }
    });

    seekSlider.addEventListener('input', () => {
        if (audioPlayer.duration) {
            const seekTo = (seekSlider.value / 100) * audioPlayer.duration;
            audioPlayer.currentTime = seekTo;
        }
    });

    // –ü—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–µ—Å–Ω–∏ - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â—É—é
    audioPlayer.addEventListener('ended', () => {
        playNext();
    });

    // –ö–ª–∏–∫ –ø–æ –ø–µ—Å–Ω–µ –≤ —Å–ø–∏—Å–∫–µ ‚Äî –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
    songs.forEach((songEl, idx) => {
        songEl.addEventListener('click', () => {
            playSong(idx);
        });
        songEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                playSong(idx);
            }
        });
    });
        async function downloadSong(event, form) {
            event.preventDefault(); // 100% –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ä–º—ã

            const formData = new FormData(form);
            const query = form.querySelector('input[name="query"]').value || "";

            try {
                const response = await fetch("/download", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();

                if (data.redirect) {
                    // –¢–µ–ø–µ—Ä—å —ç—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ
                    window.location.href = data.redirect;
                } else {
                    alert("–û—à–∏–±–∫–∞: —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω.");
                    window.location.href = "/songs?q=" + encodeURIComponent(query);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                window.location.href = "/songs?q=" + encodeURIComponent(query) + "&status=error";
            }

            return false; // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ —Ç–æ—á–Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞—Å—å
        }
        // –æ—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                
                function likeSong(event, form) {
        event.preventDefault();
        const formData = new FormData(form);

        fetch("/like", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const likeButton = form.querySelector("button");
                likeButton.disabled = true;
                likeButton.innerText = "‚ù§Ô∏è –õ–∞–π–∫–Ω—É—Ç–æ";
                likeButton.style.backgroundColor = "#ff4081";
            } else if (data.message === "–ü–µ—Å–Ω—è —É–∂–µ –ª–∞–π–∫–Ω—É—Ç–∞") {
                alert("–í—ã —É–∂–µ –ª–∞–π–∫–∞–ª–∏ —ç—Ç—É –ø–µ—Å–Ω—é.");
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ.");
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞:", error);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ.");
        });
    }
    </script>    
</body>
</html> 
